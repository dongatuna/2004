<section>
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col">               
                <!-- <h3 class="text-dark text-center"><%= course.title %> Course</h3> -->
                <br>
                <!--BEGINNING OF THE FORM-->
                <form id="course_sign_up">                                 
                    <!-- ADD AND DISPLAY CARD ELEMENT TO THE PAGE -->
                    <div class="row justify-content-center p-4">
                        <div class="col-sm-12 col-lg-4 ">
                            <!-- <p class="text-danger bg-dark rounded"><strong> Classes fill up fast.  Register now and secure your spot immediately. </strong></p> -->
                            
                            <div class="alert bg-dark text-white font-weight-bold" role="alert">
                                Pay registration fees to secure your spot in the <%= course.title %> course.
                            </div>
                        </div> 
                        

                    </div>
                    <div class="row justify-content-center">                        
                        
                        <div class="col-sm-12 col-lg-4" >                           
                            <label for = "card-element">
                                Enter credit/debit card details
                            </label>
                            
                            
                            <div id="card-element">
                                <!-- Elements will create input elements here -->
                            </div>
                            
                              <!-- We'll put the error messages in this element -->
                            <div id="card-errors" role="alert" ></div>
                            <div class="mt-2">                               
                                <button class="btn btn-primary btn-block p-3 mt-3" name="register" id="btnRegisterStudent" type="submit"><strong>Pay $ <%= course.fees %>.00 Registration Fee</strong></button> 
                                <p class="text-success"><small>Payments processed by Stripe Corporation.</small></p>
                                <p class="text-dark text-center" id="process-registration" style="display: none;"><strong>Processing...</strong></p>
                            </div>                            
                        </div>
                    </div> 
                    <br><br><br>                                             
                    
                    <!-- ADD TO THE WAITLIST BUTTON -->
                    <div class="row justify-content-center mt-2">
                        <div class="col-sm-12 col-lg-4 bg-white"> 
                            <p>Still undecided? </p>                                                                                
                            <button class="btn btn-secondary btn-sm py-3" name="waitlist" id="btnWaitlistStudent" type="submit">Waitlist me </button> 
                            <p class="text-dark text-center" id="process-waitlist" style="display: none;"><strong>Processing...</strong></p>
                        </div>
                    </div>                      
                </form>
            </div>                 
        </div>
    </div>
</section>

<script src="https://js.stripe.com/v3"></script>

<script type="application/javascript">

    //get the public stripe token
    let stripe = Stripe(<%-JSON.stringify(STRIPE_PUBLIC_KEY)%>)
    
    let elements = stripe.elements()

    // Set up Stripe.js and Elements to use in checkout form
    var style = {
        base: {
            color: "#32325d",
        }
    }
    //create card
    var card = elements.create("card", { style: style })
    //mount the card on the form
    card.mount("#card-element")
    //if card details change, note any errors and if nothing show empty string
    card.on('change', ({ error }) => {

        const displayError = document.getElementById('card-errors')

        if (error) {
            displayError.textContent = error.message
        } else {
            displayError.textContent = ''
        }
    })  

    $(document).ready( () => {       
         //get the course
        const course = (<%-JSON.stringify(course)%>)       
        
        console.log(`course---> ${JSON.stringify(course)}`)
        //get the code
        const code = localStorage.getItem('code') 
        
        //get student id
        const student_id = localStorage.getItem('student_id')
        
        //this event register a student who pays registration fees
        $("#btnRegisterStudent").on('click', async( e ) => { 
            //prevent default behavior
            e.preventDefault()         
            //hide the registration button to avoid multiple form submission           
            $('#btnRegisterStudent').hide()
            $('#btnWaitlistStudent').hide()//btnWaitlistStudent
            //show user their form submission is being processed
            $("#process-registration").show()

            const result = await stripe.createToken(card)

            //Handle result.error or result.token
            if(result.error){
                return displayError.textContent = result.error
            }  

            //get the stripe token
            const stripeToken = result.token.id 

           // construct student data
            const studentData = {
                payment : course.fees,
                stripeToken : stripeToken,
                student_id
            }             

            //send data to GA         
            gtag('event', 'Course Registration', {
                "transaction_id": course.courseId,
                "affiliation": "EHCT - Course Self Registration",  
                "currency": "USD",  
                "items": [
                    {
                        "id":  course.courseId,
                        "name": course.name,     
                        "category": "Courses", //course_name,
                        // "variant": course.type,     
                        "quantity": 1,
                        "price": course.fees 
                    }
                ]
            })
            debugger

            $.ajax({
                type: 'POST', 
                url: `/students/register/${code}/${course.courseId}`,
                credentials: 'same-origin', // <-- includes cookies in the request
                headers: {
                    Accept: "application/json",
                    // "Content-Type": "application/json",
                    // 'CSRF-Token': token
                },
                dataType: "json",
                data: studentData,
            }).done(function (response) {
                if (response.redirect !== undefined && response.redirect) {
                    //add local storage items for student id and if student registered or waitlisted
                    
                    localStorage.setItem('registered', response.registered)
                    debugger
                   // alert(response.message)
                    //window.location.replace(response.redirect_url)
                    window.location.href = response.redirect_url
                }      
                //if something is wrong - alert user and redirect user to course schedule page
                if (response.redirect !== undefined && !response.redirect) {
                    
                    alert('Something went wrong - start the registration process again!')
                    window.location.href = `/select-payment/${code}/${course.courseId}` 
                    // window.location.replace('/courses')
                }                   
            })            
        })         
        
        $("#btnWaitlistStudent").on('click', e => {
                        
            //prevent default behavior
            e.preventDefault()   
            //check to make sure that the student doesn't really want to go on without paying
            const response = confirm("Please pay $ 75.00 to register for the class. It's part of tuition cost.")

            if(response){
                //hide the registration button to avoid multiple form submission           
                $('#btnRegisterStudent').hide()
                $('#btnWaitlistStudent').hide()
                //show user their form submission is being processed
                $("#process-waitlist").show()                

               //  get the course id for the course -> student will be added to the course with course id          
                gtag('event', 'Course Add To Waitlist', {
                    "transaction_id":  course.courseId,
                    "affiliation": "EHCT - Course Self Registration",  
                    "currency": "USD",  
                    "items": [
                        {
                            "id":  course.courseId,
                            "name": course.name,     
                            "category": "Courses", //course_name,
                            // "variant": course.type,     
                            "quantity": 1,
                            "price": course.fees*1/3 
                        }
                    ]
                }) 
                //send registrant to job search page
                window.location.href = '/start-job-search'
            }           
        })   
    })    

</script>
<style>
   
    .StripeElement {
    box-sizing: border-box;

    height: 40px;

    padding: 10px 12px;

    /* border: 1px solid transparent; */
    border: 2px solid green;
    border-radius: 4px;
    background-color: white;

    box-shadow: 0 1px 3px 0 #e6ebf1;
    -webkit-transition: box-shadow 150ms ease;
    transition: box-shadow 150ms ease;
    }

    .StripeElement--focus {
    box-shadow: 0 1px 3px 0 #cfd7df;
    }

    .StripeElement--invalid {
    border-color: #fa755a;
    }

    .StripeElement--webkit-autofill {
    background-color: #fefde5 !important;
    }

</style>